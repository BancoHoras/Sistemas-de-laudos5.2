<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Posto de Sa√∫de v6.3 (Completo)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            --primary-color: #00A896;
            --secondary-color: #02C39A;
            --accent-color: #F0F3BD;
            --danger-color: #E63946;
            --warning-color: #FCA311;
            --info-color: #457B9D;
            --hcg-color: #8338EC;

            --sidebar-bg: linear-gradient(180deg, #05668D 0%, #028090 100%);
            --sidebar-text: #FFFFFF;
            --sidebar-active-bg: #00A896;
            --sidebar-logout-bg: #c9404d;

            --bg-color: #F0F2F5;
            --card-bg: #FFFFFF;
            --text-color: #1D3557;
            --text-light: #6c757d;
            --border-color: #E9ECEF;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        body.dark-theme {
            --sidebar-bg: linear-gradient(180deg, #1D3557 0%, #2B4264 100%);
            --sidebar-logout-bg: #a1333e;
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --text-color: #EAEAEA;
            --text-light: #a0a0a0;
            --border-color: #333;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        * { box-sizing: border-box; }
        body {
            font-family: var(--font-family); margin: 0; background-color: var(--bg-color); color: var(--text-color);
            display: flex; transition: background-color 0.3s, color 0.3s;
        }
        .sidebar {
            width: 240px; background: var(--sidebar-bg); color: var(--sidebar-text); height: 100vh; padding: 20px 0;
            position: fixed; display: flex; flex-direction: column; z-index: 100;
        }
        .sidebar-header { padding: 0 20px; text-align: center; }
        .sidebar-header h2 { margin-bottom: 5px; }
        .theme-switcher { cursor: pointer; font-size: 24px; user-select: none; }
        .sidebar nav { margin-top: 30px; display: flex; flex-direction: column; flex-grow: 1;}
        .sidebar nav a {
            display: flex; align-items: center; gap: 15px; color: var(--sidebar-text); padding: 15px 20px;
            text-decoration: none; transition: background-color 0.3s, color 0.3s; border-left: 4px solid transparent;
        }
        .sidebar nav a:hover { background-color: rgba(255, 255, 255, 0.1); }
        .sidebar nav a.active { background-color: var(--sidebar-active-bg); font-weight: 600; border-left-color: var(--accent-color); }
        #logout-link {
            margin-top: auto;
            background-color: var(--sidebar-logout-bg);
            font-weight: 600;
        }
        .main-content { margin-left: 240px; flex-grow: 1; padding: 30px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card {
            background-color: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: var(--shadow);
            margin-bottom: 30px; transition: background-color 0.3s;
        }
        .card h3, .card h4 {
            margin-top: 0; color: var(--text-color); border-bottom: 1px solid var(--border-color); padding-bottom: 15px;
            margin-bottom: 20px; font-size: 1.25rem;
        }
        .card h4 { font-size: 1rem; border-bottom-style: dashed; }
        .form-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .form-group { flex: 1; min-width: 250px; display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 8px; font-weight: 500; font-size: 0.9em; }
        .form-group input, .form-group select {
            padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em;
            font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color);
            text-transform: uppercase; transition: all 0.3s;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 168, 150, 0.2); outline: none;
        }
        .radio-group { display: flex; align-items: center; gap: 20px; padding-top: 10px; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s; }
        .btn-sm { padding: 6px 12px; font-size: 0.8em; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--secondary-color); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .btn-secondary { background-color: var(--info-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-edit { background-color: var(--warning-color); color: white; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95rem; }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { font-weight: 600; font-size: 0.85em; text-transform: uppercase; }
        .data-table tr:last-child td { border-bottom: none; }
        .actions-cell { display: flex; gap: 8px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .kpi-card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border-left: 5px solid var(--primary-color); }
        .kpi-card.warning { border-left-color: var(--warning-color); }
        .kpi-card.hcg { border-left-color: var(--hcg-color); }
        .kpi-card .kpi-title { font-size: 1rem; color: var(--text-light); margin: 0 0 10px 0; }
        .kpi-card .kpi-value { font-size: 2.5rem; font-weight: 700; margin: 0; }
        .charts-container { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; align-items: center; }
        #laudo-dengue-container, #laudo-covid-container, #laudo-hcg-container { display: none; position: fixed; top: 0; left: -3000px; z-index: -1000; background: #fff; }
        .laudo-pdf { width: 210mm; min-height: 297mm; padding: 15mm; box-sizing: border-box; background: white; color: black; font-family: Arial, Helvetica, sans-serif; font-size: 11pt; display: flex; flex-direction: column; }
        .laudo-pdf p { margin: 5px 0; }
        .laudo-pdf .laudo-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid black; padding-bottom: 5mm; }
        .laudo-pdf .header-left { flex-basis: 40%; }
        .laudo-pdf .header-left img { max-height: 50px; margin-bottom: 5px; }
        .laudo-pdf .header-right { flex-basis: 40%; text-align: right; }
        .laudo-pdf .header-right .sms-title { font-size: 24pt; font-weight: bold; line-height: 1; margin-bottom: 0; }
        .laudo-pdf .header-right .city-name { font-size: 16pt; font-weight: bold; margin-top: 0; }
        .laudo-pdf .laudo-title { text-align: center; font-size: 13pt; font-weight: bold; margin: 5mm 0 1mm 0; }
        .laudo-pdf .laudo-subtitle { text-align: center; font-size: 11pt; margin-bottom: 5mm; }
        .laudo-pdf .laudo-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 2mm; }
        .laudo-pdf .laudo-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5mm; }
        .laudo-pdf .laudo-block { font-weight: bold; border: 1.5px solid black; padding: 2mm; margin: 3mm 0; text-align: center; font-size: 12pt; }
        .laudo-pdf .result-options { font-size: 12pt; line-height: 1.5; }
        .laudo-pdf .result-options span { font-weight: bold; font-family: 'Courier New', Courier, monospace; }
        .laudo-pdf .nota-condicional, .laudo-pdf .reference-box { border: 1px solid #333; padding: 3mm; font-size: 10pt; text-align: justify; margin: 3mm 0; }
        .laudo-pdf .nota-box { border: 1.5px solid black; padding: 3mm; margin-top: 5mm; font-size: 9pt; text-align: justify; }
        .laudo-pdf .signature-section { margin-top: 8mm; display: flex; justify-content: space-between; align-items: flex-end; }
        .laudo-pdf .signature-box { flex: 1; padding: 0 5mm; text-align: left;}
        .laudo-pdf .signature-line { border-top: 1px solid black; margin-top: 10mm; width: 80%; margin-left: 0;}
        .laudo-pdf .signature-name { margin-top: 2mm; font-weight: bold; }
        .laudo-pdf .laudo-footer { margin-top: auto; padding-top: 5mm; font-size: 8pt; text-align: center; }
        .laudo-pdf .laudo-footer hr { border: none; border-top: 1px solid black; margin: 3mm 0; }
        .laudo-pdf .laudo-footer p { margin: 1px 0; }
        .laudo-pdf .patient-box, .laudo-pdf .test-details-box, .laudo-pdf .result-box, .laudo-pdf .info-box { border: 1.5px solid black; padding: 3mm; margin-top: 5mm; }
        .laudo-pdf .box-title { font-size: 11pt; font-weight: bold; text-align: left; margin-bottom: 2mm; }
        .laudo-pdf .check-options { margin-left: 5mm; font-size: 12pt; display: flex; align-items: center; }
        .laudo-pdf .check-options input { margin-right: 5px; }
        .laudo-pdf .single-line-result { font-weight: bold; font-size: 12pt; text-align: center; }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 1.5rem; flex-direction: column; }
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid #00A896; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* General styles for text fields within PDF templates */
        .laudo-pdf span[id^="pdf-"] {
            border-bottom: none; /* REMOVIDO SUBLINHADO */
            display: inline-block;
            min-width: 10px; /* Reduzido ainda mais o min-width para flexibilidade */
            padding: 0 1px; /* Reduzido padding */
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: bottom;
            box-sizing: border-box;
            line-height: 1.2;
            flex-grow: 1; /* Permite que o span cres√ßa para preencher o espa√ßo */
            flex-shrink: 1; /* Permite que o span encolha */
        }
        .laudo-pdf .info-label {
            font-weight: bold;
            display: inline-block;
            min-width: 40px; /* Reduzido min-width para o label */
            margin-right: 0px; /* Reduzido espa√ßamento do label ao m√°ximo */
            white-space: nowrap;
            flex-shrink: 0;
        }
        /* Flexbox para cada par label-span para alinhamento */
        .laudo-pdf .info-box p {
            margin: 1px 0; /* Reduzido margin vertical para os par√°grafos */
            display: flex;
            align-items: baseline;
            line-height: 1.2;
            flex-wrap: nowrap; /* Tenta manter label e dado na mesma linha */
            justify-content: flex-start; /* Alinha o conte√∫do √† esquerda */
        }
        /* Ajustes espec√≠ficos para a grade de 3 colunas em Dengue */
        #laudo-dengue-container .laudo-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr)); /* Usa minmax(0, 1fr) para maior flexibilidade */
            gap: 1mm 1mm; /* Reduzido espa√ßamento entre colunas e linhas */
            align-items: start;
        }
        #laudo-dengue-container .laudo-grid-3 p {
            display: flex; /* Mant√©m flex para label-span dentro da c√©lula do grid */
            align-items: baseline;
            flex-wrap: nowrap; /* Tenta manter label e dado na mesma linha se poss√≠vel */
            margin: 0; /* Remove margin do P dentro do grid para evitar espa√ßamentos extras */
            white-space: nowrap; /* Impede que o par label-span quebre linha na c√©lula do grid */
        }
        #laudo-dengue-container .laudo-grid-3 p span[id^="pdf-"] {
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
        }

        /* Campos que precisam de mais espa√ßo horizontalmente (Nome, Unidade) */
        #laudo-dengue-container .laudo-grid-3 p:nth-child(1), /* Nome do Usu√°rio */
        #laudo-dengue-container .laudo-grid-3 p:nth-child(4) /* Unidade de Realiza√ß√£o */
        {
            grid-column: span 3; /* Faz com que ocupem todas as 3 colunas */
            flex-wrap: wrap; /* Permite que o conte√∫do quebre a linha se for muito longo */
            align-items: flex-start;
            white-space: normal; /* Permite quebrar a linha para nome e unidade */
        }
        #laudo-dengue-container .laudo-grid-3 p:nth-child(1) span,
        #laudo-dengue-container .laudo-grid-3 p:nth-child(4) span {
            overflow: visible;
            text-overflow: clip;
        }
        #laudo-dengue-container .laudo-grid-3 p:nth-child(1) .info-label,
        #laudo-dengue-container .laudo-grid-3 p:nth-child(4) .info-label {
            min-width: auto;
            margin-right: 5px;
        }
        /* Garantir que a Data de Nascimento e Lote tenham espa√ßo suficiente e n√£o sejam cortados */
        #laudo-dengue-container #pdf-dengue-nascimento,
        #laudo-dengue-container #pdf-dengue-lote,
        #laudo-dengue-container #pdf-dengue-validade,
        #laudo-dengue-container #pdf-dengue-data-coleta,
        #laudo-dengue-container #pdf-dengue-inicio-sintomas,
        #laudo-dengue-container #pdf-dengue-sexo,
        #laudo-dengue-container #pdf-dengue-cpf {
            min-width: 40px; /* Min-width para todos os campos de dados */
        }


        /* Ajustes para o cabe√ßalho e rodap√© */
        .laudo-pdf {
            padding: 10mm 15mm;
            min-height: 287mm;
            justify-content: space-between;
        }
        .laudo-pdf .signature-section .signature-box:last-child {
            flex-basis: 35%;
            flex-grow: 0;
            text-align: right;
            margin-top: 0;
            padding-top: 0;
        }
        .laudo-pdf .signature-section .signature-box:first-child {
            flex-basis: 60%;
            flex-grow: 1;
        }
        .laudo-pdf .signature-section {
            align-items: flex-start;
        }
        .laudo-pdf .laudo-footer {
            margin-top: 10mm;
        }
        /* Diminuir a fonte dos dados em todos os laudos para tentar caber */
        .laudo-pdf span[id^="pdf-"] {
            font-size: 9.5pt; /* Reduz a fonte dos dados em general */
        }
        .laudo-pdf .info-label {
            font-size: 9.5pt; /* Reduz a fonte dos labels em general */
        }
        /* Aumenta a fonte do nome do usu√°rio um pouco se for quebrar, para prioriz√°-lo */
        #pdf-dengue-nome, #pdf-covid-nome, #pdf-hcg-nome {
            font-size: 10pt; /* Mant√©m o nome ligeiramente maior, mas pode ser necess√°rio ajuste fino */
        }

        /* --- ESTILOS ESPEC√çFICOS PARA COVID --- */
        #laudo-covid-container .laudo-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 colunas */
            gap: 1mm 1mm; /* Espa√ßamento reduzido */
            align-items: start;
        }
        #laudo-covid-container .laudo-grid-2 p {
            display: flex;
            align-items: baseline;
            flex-wrap: nowrap;
            margin: 0;
            white-space: nowrap;
        }
        #laudo-covid-container .laudo-grid-2 p span[id^="pdf-"] {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Ajuste para o nome do paciente no COVID que pode ser mais longo */
        #laudo-covid-container #pdf-covid-nome {
            white-space: normal; /* Permite quebrar a linha */
            overflow: visible;
            text-overflow: clip;
        }
        /* Ajuste para garantir que labels e dados se alinhem bem dentro das c√©lulas da grade */
        #laudo-covid-container .laudo-grid-2 p .info-label {
            min-width: 90px; /* Dar mais espa√ßo ao label se o dado for curto */
            margin-right: 2px;
        }
        #laudo-covid-container .laudo-grid-2 p span {
            min-width: 40px;
        }


        /* --- ESTILOS ESPEC√çFICOS PARA HCG --- */
        #laudo-hcg-container .laudo-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 colunas */
            gap: 1mm 1mm; /* Espa√ßamento reduzido */
            align-items: start;
        }
        #laudo-hcg-container .laudo-grid-2 p {
            display: flex;
            align-items: baseline;
            flex-wrap: nowrap;
            margin: 0;
            white-space: nowrap;
        }
        #laudo-hcg-container .laudo-grid-2 p span[id^="pdf-"] {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Ajuste para o nome do usu√°rio no HCG que pode ser mais longo */
        #laudo-hcg-container #pdf-hcg-nome {
            white-space: normal; /* Permite quebrar a linha */
            overflow: visible;
            text-overflow: clip;
        }
        /* Ajuste para garantir que labels e dados se alinhem bem dentro das c√©lulas da grade */
        #laudo-hcg-container .laudo-grid-2 p .info-label {
            min-width: 90px; /* Dar mais espa√ßo ao label se o dado for curto */
            margin-right: 2px;
        }
        #laudo-hcg-container .laudo-grid-2 p span {
            min-width: 40px;
        }

    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Sa√∫deSys v6</h2>
            <span class="theme-switcher" id="theme-switcher">üåô</span>
        </div>
        <nav>
            <a href="#" class="nav-link" onclick="showPage('dashboard')">üìä Dashboard</a>
            <a href="#" class="nav-link" onclick="showPage('cadastro')">‚ûï Cadastrar Teste</a>
            <a href="#" class="nav-link" onclick="showPage('relatorios')">üìã Relat√≥rios</a>
            <a href="#" class="nav-link" onclick="accessStockPage()">üì¶ Estoque</a>
            <a href="#" class="nav-link" id="logout-link" onclick="logout()" style="display: none;">üîí Logout Admin</a>
            <a href="#" class="nav-link" onclick="showPage('indicadores')">üìà Indicadores</a> </nav>
    </div>

    <div class="main-content">
        <div id="dashboard" class="page">
            <h3>Dashboard</h3>
            <div class="kpi-grid">
                <div class="kpi-card"><p class="kpi-title">Total de Testes</p><h2 class="kpi-value" id="kpi-total-testes">0</h2></div>
                <div class="kpi-card"><p class="kpi-title">Testes de Dengue</p><h2 class="kpi-value" id="kpi-total-dengue">0</h2></div>
                <div class="kpi-card"><p class="kpi-title">Testes de COVID</p><h2 class="kpi-value" id="kpi-total-covid">0</h2></div>
                <div class="kpi-card hcg"><p class="kpi-title">Testes de HCG</p><h2 class="kpi-value" id="kpi-total-hcg">0</h2></div>
                <div class="kpi-card warning"><p class="kpi-title">Resultados Positivos</p><h2 class="kpi-value" id="kpi-total-positivos">0</h2></div>
            </div>
            <div class="card" style="margin-top: 30px;">
                <div class="charts-container">
                    <div><canvas id="typeChart"></canvas></div>
                    <div><canvas id="resultChart"></canvas></div>
                </div>
            </div>
            <div class="card">
                <h3>Atividades Recentes</h3>
                <table class="data-table">
                    <thead><tr><th>Paciente</th><th>Tipo Teste</th><th>Resultado</th><th>Profissional</th></tr></thead>
                    <tbody id="recent-activity-body"></tbody>
                </table>
            </div>
        </div>

        <div id="cadastro" class="page">
            <div class="card">
                <h3>Novo Teste</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="tipo-teste">Selecione o Tipo de Teste</label>
                        <select id="tipo-teste" onchange="toggleTestForm()">
                            <option value="DENGUE">Teste de Dengue NS1</option>
                            <option value="COVID">Teste R√°pido de Ant√≠geno COVID-19</option>
                            <option value="HCG">Teste R√°pido de Detec√ß√£o de HCG</option>
                        </select>
                    </div>
                    <div class="form-group">
                         <label for="profissional-responsavel">Profissional Respons√°vel</label>
                         <input type="text" id="profissional-responsavel" required>
                    </div>
                </div>
                <form id="form-dengue" style="display: none;">
                    <h4>Dados do Paciente</h4>
                    <div class="form-row">
                        <div class="form-group"><label for="dengue-nome">Nome</label><input type="text" id="dengue-nome" required></div>
                        <div class="form-group"><label for="dengue-cpf">CPF</label><input type="text" id="dengue-cpf"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="dengue-nascimento">Nascimento</label><input type="date" id="dengue-nascimento" required></div>
                        <div class="form-group"><label for="dengue-sexo">Sexo</label><input type="text" id="dengue-sexo"></div>
                    </div>
                    <h4>Dados do Teste</h4>
                     <div class="form-row">
                        <div class="form-group"><label for="dengue-lote">Selecione o Lote</label><select id="dengue-lote" required></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="dengue-inicio-sintomas">In√≠cio dos sintomas</label><input type="date" id="dengue-inicio-sintomas" required></div>
                        <div class="form-group"><label for="dengue-data-coleta">Data da coleta</label><input type="date" id="dengue-data-coleta" required></div>
                    </div>
                    <h4>Resultado</h4>
                    <div class="form-group"><div class="radio-group"><label><input type="radio" name="dengue-resultado" value="POSITIVO" required> Positivo</label><label><input type="radio" name="dengue-resultado" value="NEGATIVO"> Negativo</label><label><input type="radio" name="dengue-resultado" value="INCONCLUSIVO"> Inconclusivo</label></div></div>
                    <div class="btn-container"><button type="button" class="btn btn-primary" onclick="salvarTeste('DENGUE')">Salvar Teste</button></div>
                </form>

                <form id="form-covid" style="display: none;">
                     <h4>Dados do Paciente</h4>
                     <div class="form-row">
                        <div class="form-group"><label for="covid-nome">Nome</label><input type="text" id="covid-nome" required></div>
                        <div class="form-group"><label for="covid-cidade">Cidade</label><input type="text" id="covid-cidade" value="NOVO HAMBURGO"></div>
                    </div>
                    <div class="form-row">
                         <div class="form-group"><label for="covid-nascimento">Nascimento</label><input type="date" id="covid-nascimento" required></div>
                        <div class="form-group"><label for="covid-sexo">Sexo</label><input type="text" id="covid-sexo"></div>
                    </div>
                    <h4>Dados do Teste</h4>
                     <div class="form-row">
                        <div class="form-group"><label for="covid-lote">Selecione o Lote</label><select id="covid-lote" required></select></div>
                         <div class="form-group"><label>Amostra</label><div class="radio-group"><label><input type="radio" name="covid-amostra" value="SWAB NASOFARINGEO" checked> Swab nasofar√≠ngeo</label><label><input type="radio" name="covid-amostra" value="SWAB NASAL"> Swab nasal</label></div></div>
                    </div>
                    <h4>Resultado</h4>
                    <div class="form-group"><div class="radio-group"><label><input type="radio" name="covid-resultado" value="POSITIVO" required> Positivo</label><label><input type="radio" name="covid-resultado" value="NEGATIVO"> Negativo</label></div></div>
                    <div class="btn-container"><button type="button" class="btn btn-primary" onclick="salvarTeste('COVID')">Salvar Teste</button></div>
                </form>

                <form id="form-hcg" style="display: none;">
                     <h4>Dados da Paciente</h4>
                     <div class="form-row">
                        <div class="form-group"><label for="hcg-nome">Nome do usu√°rio</label><input type="text" id="hcg-nome" required></div>
                        <div class="form-group"><label for="hcg-prontuario">Prontu√°rio</label><input type="text" id="hcg-prontuario"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="hcg-identidade">Identidade</label><input type="text" id="hcg-identidade"></div>
                        <div class="form-group"><label for="hcg-nascimento">Data de Nascimento</label><input type="date" id="hcg-nascimento" required></div>
                    </div>
                    <h4>Dados do Teste</h4>
                     <div class="form-row">
                        <div class="form-group"><label for="hcg-lote">Selecione o Lote</label><select id="hcg-lote" required></select></div>
                        <div class="form-group"><label for="hcg-data-coleta">Data da coleta</label><input type="date" id="hcg-data-coleta" required></div>
                    </div>
                    <h4>Resultado</h4>
                    <div class="form-group"><label for="hcg-resultado">Resultado do Teste</label><input type="text" id="hcg-resultado" placeholder="Ex: POSITIVO > 25MUI/ML" required></div>
                    <div class="btn-container"><button type="button" class="btn btn-primary" onclick="salvarTeste('HCG')">Salvar Teste</button></div>
                </form>
            </div>
        </div>

        <div id="relatorios" class="page">
            <div class="card">
                <h3>Relat√≥rio de Testes Realizados</h3>
                <table class="data-table">
                    <thead><tr><th>Paciente</th><th>CPF/ID</th><th>Tipo</th><th>Data</th><th>Resultado</th><th>Profissional</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="report-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="estoque" class="page">
            <div class="card">
                <h3>Adicionar Novo Lote de Teste</h3>
                <form id="form-add-stock">
                    <div class="form-row">
                         <div class="form-group">
                            <label for="stock-tipo">Tipo de Teste</label>
                            <select id="stock-tipo" required>
                                <option value="" disabled selected>Selecione...</option>
                                <option value="DENGUE">Dengue NS1</option>
                                <option value="COVID">COVID-19 Ant√≠geno</option>
                                <option value="HCG">Detec√ß√£o de HCG</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="stock-lote">C√≥digo do Lote</label><input type="text" id="stock-lote" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="stock-validade">Data de Validade</label><input type="date" id="stock-validade" required></div>
                        <div class="form-group"><label for="stock-quantidade">Quantidade</label><input type="number" id="stock-quantidade" min="1" required></div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="adicionarLote()">Salvar Lote</button>
                </form>
            </div>
            <div class="card">
                <h3>Estoque Atual</h3>
                <table class="data-table">
                    <thead><tr><th>Tipo</th><th>Lote</th><th>Validade</th><th>Qtd.</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="stock-table-body"></tbody>
                </table>
            </div>
        </div>
        
        <div id="indicadores" class="page">
            <div class="card">
                <h3>Novo Indicador</h3>
                <form id="form-indicador">
                    <div class="form-row">
                        <div class="form-group"><label for="indicador-gmus">G'mus</label><input type="text" id="indicador-gmus" placeholder="Ex: 3/5, 4/5" required></div>
                        <div class="form-group"><label for="indicador-pressao">Press√£o</label><input type="text" id="indicador-pressao" placeholder="Ex: 120/80 mmHg" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="indicador-hgt">HGT</label><input type="number" id="indicador-hgt" required></div>
                        <div class="form-group"><label for="indicador-peso">Peso (kg)</label><input type="number" step="0.1" id="indicador-peso" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="indicador-estatura">Estatura (m)</label><input type="number" step="0.01" id="indicador-estatura" required></div>
                        <div class="form-group"><label for="indicador-profissional">Profissional</label><input type="text" id="indicador-profissional" required></div>
                    </div>
                    <div class="form-group"><label for="indicador-obs">Observa√ß√µes</label><textarea id="indicador-obs" rows="3"></textarea></div>
                    <button type="button" class="btn btn-primary" onclick="salvarIndicador()">Salvar Indicador</button>
                </form>
            </div>
            <div class="card">
                <h3>Relat√≥rios de Indicadores</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="exportIndicators('csv')">Exportar CSV</button>
                    <button class="btn btn-secondary" onclick="exportIndicators('pdf')">Exportar PDF</button>
                </div>
                <table class="data-table">
                    <thead><tr><th>Data</th><th>G'mus</th><th>Press√£o</th><th>HGT</th><th>Peso</th><th>Estatura</th><th>Profissional</th><th>Obs</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="indicators-table-body"></tbody>
                </table>
            </div>
        </div>


    </div>

    <div id="laudo-dengue-container">
        <div class="laudo-pdf">
            <div class="laudo-header">
                <div class="header-left">
                    <img src="https://via.placeholder.com/100x50?text=LOGO" alt="Logo Prefeitura" class="logo-left">
                    <p>Estado do Rio Grande do Sul</p>
                    <p>Secretaria de Sa√∫de</p>
                </div>
                <div class="header-right">
                    <div class="sms-title">SMS</div>
                    <p class="city-name">NOVO HAMBURGO</p>
                </div>
            </div>
            <div style="border-bottom: 2px solid black; margin-bottom: 10px; padding-bottom: 5px;">
                <p class="laudo-title" style="margin-top: 10px; margin-bottom: 5px;">TESTE DE ANT√çGENO PARA DENGUE - NS1</p>
                <p class="laudo-subtitle">(Vida Rapid Test - Vida Biotecnologia)</p>
            </div>

            <div class="info-box">
                <p class="box-title">IDENTIFICA√á√ÉO DO PACIENTE</p>
                <div class="laudo-grid-3">
                    <p style="grid-column: span 3; display: flex; align-items: baseline;"><span class="info-label" style="min-width: 90px;">Nome do Usu√°rio:</span> <span id="pdf-dengue-nome" style="width: calc(100% - 95px); text-align: left; white-space: normal; overflow: visible; text-overflow: clip; font-size: 10.5pt;"></span></p>
                    <p><span class="info-label" style="min-width: 70px;">Identidade / CPF:</span> <span id="pdf-dengue-cpf"></span></p>
                    <p><span class="info-label" style="min-width: 70px;">Data de Nascimento:</span> <span id="pdf-dengue-nascimento"></span></p>
                    <p style="grid-column: span 3; display: flex; align-items: baseline;"><span class="info-label" style="min-width: 90px;">Unidade de Realiza√ß√£o do Exame:</span> <span style="display: inline-block; width: auto; flex-grow: 1; white-space: normal; overflow: visible; text-overflow: clip;">Posto de Sa√∫de Central</span></p>
                    <p><span class="info-label" style="min-width: 70px;">Sexo:</span> <span id="pdf-dengue-sexo"></span></p>
                    <p><span class="info-label" style="min-width: 70px;">Lote:</span> <span id="pdf-dengue-lote"></span></p>
                    <p><span class="info-label" style="min-width: 70px;">Data do In√≠cio dos Sintomas:</span> <span id="pdf-dengue-inicio-sintomas"></span></p>
                    <p><span class="info-label" style="min-width: 70px;">Validade:</span> <span id="pdf-dengue-validade"></span></p>
                    <p><span class="info-label" style="min-width: 70px;">Data da Coleta da Amostra:</span> <span id="pdf-dengue-data-coleta"></span></p>
                </div>
            </div>

            <div class="info-box" style="margin-top: 15px;">
                <p class="box-title">INFORMA√á√ïES DO TESTE</p>
                <p style="margin: 5px 0;"><span class="info-label">Amostra:</span> Pun√ß√£o digital</p>
                <p style="margin: 5px 0;"><span class="info-label">Teste:</span> Vida Rapid Test - Dengue NS1 (Vida Biotecnologia)</p>
                <p style="margin: 5px 0;"><span class="info-label">M√©todo:</span> Imunocromatografia</p>
            </div>

            <div class="result-box" style="margin-top: 15px;">
                <p class="box-title">RESULTADO</p>
                <div class="check-options">
                    <label>
                        <input type="checkbox" id="dengue-result-positivo" disabled>
                        <span>POSITIVO</span>
                    </label>
                    <label style="margin-left: 20mm;">
                        <input type="checkbox" id="dengue-result-negativo" disabled>
                        <span>NEGATIVO</span>
                    </label>
                    <label style="margin-left: 20mm;">
                        <input type="checkbox" id="dengue-result-inconclusivo" disabled>
                        <span>INCONCLUSIVO</span>
                    </label>
                </div>
            </div>

            <div class="nota-box" style="margin-top: 15px;">
                <p><strong>Notas:</strong></p>
                <p>1. O teste r√°pido para detec√ß√£o de ant√≠geno NS1 √© um m√©todo auxiliar no diagn√≥stico da infec√ß√£o por dengue e deve ser interpretado em conjunto com os sinais cl√≠nicos, hist√≥rico epidemiol√≥gico e outros exames laboratoriais.</p>
                <p>2. Um resultado NEGATIVO n√£o exclui a infec√ß√£o por dengue, especialmente se a amostra foi coletada antes do 1¬∫ dia de sintomas (per√≠odo de viremia inicial) ou ap√≥s o 5¬∫ dia de sintomas, quando a quantidade de ant√≠geno pode diminuir. Em caso de persist√™ncia dos sintomas ou forte suspeita cl√≠nica, recomenda-se a coleta de nova amostra ou a realiza√ß√£o de outros testes.</p>
                <p>3. Um resultado POSITIVO sugere infec√ß√£o ativa por dengue. O manejo do paciente deve seguir as diretrizes cl√≠nicas e de vigil√¢ncia epidemiol√≥gica.</p>
                <p>4. Em casos de resultado INCONCLUSIVO, uma nova amostra ou m√©todo alternativo √© recomendado para confirma√ß√£o.</p>
            </div>

            <div class="signature-section" style="margin-top: 20mm; flex-wrap: wrap;">
                <div class="signature-box" style="text-align: left; flex-basis: 60%;">
                    <p class="signature-name" style="margin-bottom: 0; font-size: 10.5pt;"><span id="pdf-dengue-profissional" style="border-bottom: 1px solid black; width: 100%; display: block; white-space: normal; overflow: visible; text-overflow: clip;"></span></p>
                    <p style="margin-top: 2mm; margin-bottom: 0; font-size: 10.5pt;">CRM/Outro Registro: [Registro]</p>
                    <p style="margin-top: 2mm; font-size: 10.5pt;">Assinatura e Carimbo</p>
                </div>
                <div class="signature-box" style="text-align: right; flex-basis: 35%;">
                    <p style="margin-top: 0; font-size: 10.5pt;">Novo Hamburgo, <span id="pdf-dengue-data-emissao"></span></p>
                </div>
            </div>

            <div class="laudo-footer">
                <hr>
                <p>SECRETARIA MUNICIPAL DE SA√öDE - NOVO HAMBURGO</p>
                <p>[Endere√ßo Completo do Posto de Sa√∫de]</p>
                <p>Telefone: [Telefone do Posto] | E-mail: [Email do Posto]</p>
            </div>
        </div>
    </div>

    <div id="laudo-covid-container">
        <div class="laudo-pdf">
            <div class="laudo-header">
                <div class="header-left">
                    <img src="https://via.placeholder.com/100x50?text=LOGO" alt="Logo Prefeitura" class="logo-left">
                    <p>Estado do Rio Grande do Sul</p>
                    <p>Secretaria de Sa√∫de</p>
                </div>
                <div class="header-right">
                    <div class="sms-title">SA√öDE</div>
                    <p class="city-name">PREFEITURA<br>NOVO HAMBURGO</p>
                </div>
            </div>
            <div style="border-bottom: 2px solid black; margin-bottom: 10px; padding-bottom: 5px;">
                <p class="laudo-title" style="margin-top: 10px; margin-bottom: 5px;">LAUDO</p>
                <p class="laudo-subtitle">TESTE R√ÅPIDO DE ANT√çGENO PARA COVID-19</p>
            </div>

            <div class="info-box">
                <p class="box-title">IDENTIFICA√á√ÉO DO PACIENTE</p>
                <div class="laudo-grid-2">
                    <p><span class="info-label">Nome do paciente:</span> <span id="pdf-covid-nome"></span></p>
                    <p><span class="info-label">Cidade:</span> <span id="pdf-covid-cidade"></span></p>
                    <p><span class="info-label">Sexo:</span> <span id="pdf-covid-sexo"></span></p>
                    <p><span class="info-label">Data de nascimento:</span> <span id="pdf-covid-nascimento"></span></p>
                </div>
            </div>

            <div class="info-box" style="margin-top: 15px;">
                <p class="box-title">TESTE</p>
                <div class="laudo-grid-2">
                    <p><span class="info-label">Fabricante:</span> <span id="pdf-covid-fabricante"></span></p>
                    <p><span class="info-label">Lote:</span> <span id="pdf-covid-lote"></span></p>
                    <p><span class="info-label">M√©todo:</span> <span id="pdf-covid-metodo"></span></p>
                    <p><span class="info-label">Data da Coleta:</span> <span id="pdf-covid-data-coleta"></span></p> </div>
                <p style="margin-top: 10px;"><span class="info-label">Amostra:</span></p>
                <div class="check-options" style="margin-left: 20mm;">
                    <label>
                        <input type="checkbox" id="covid-amostra-nasofaringeo" disabled>
                        <span>SWAB NASOFAR√çNGEO</span>
                    </label>
                    <label style="margin-left: 20mm;">
                        <input type="checkbox" id="covid-amostra-nasal" disabled>
                        <span>SWAB NASAL</span>
                    </label>
                </div>
            </div>

            <div class="result-box" style="margin-top: 15px;">
                <p class="box-title">RESULTADO DO TESTE</p>
                <div class="check-options">
                    <label>
                        <input type="checkbox" id="covid-result-positivo" disabled>
                        <span>Positivo</span>
                    </label>
                    <label style="margin-left: 20mm;">
                        <input type="checkbox" id="covid-result-negativo" disabled>
                        <span>Negativo</span>
                    </label>
                </div>
            </div>

            <div class="nota-box" style="margin-top: 15px;">
                <p><strong>Observa√ß√µes:</strong></p>
                <p>1. O teste r√°pido √© utilizado como aux√≠lio diagn√≥stico para a COVID-19.</p>
                <p>2. Mediante avalia√ß√£o cl√≠nica e epidemiol√≥gica, testes de ant√≠geno com resultado positivo podem ser considerados confirmat√≥rios e os pacientes devem ser isolados e tratados clinicamente conforme necess√°rio.</p>
                <p>3. Dada a sensibilidade esperada dos testes de ant√≠geno, um resultado negativo n√£o exclui uma poss√≠vel infec√ß√£o, e o RT-PCR deve ser realizado para pacientes sintom√°ticos com resultado de ant√≠geno negativo, permanecendo a suspeita cl√≠nica.</p>
            </div>

            <div class="signature-section" style="margin-top: 20mm;">
                <div class="signature-box" style="text-align: left;">
                    <p class="signature-name"><span id="pdf-covid-profissional"></span></p>
                    <p class="signature-line" style="width: 70%;"></p>
                    <p>Respons√°vel T√©cnico:</p>
                    <p>(carimbo e assinatura)</p>
                </div>
                <div class="signature-box" style="text-align: right;">
                    <p>Data: <span id="pdf-covid-data-emissao"></span></p>
                </div>
            </div>

            <div class="laudo-footer">
                <hr>
                <p>LAUDO</p>
            </div>
        </div>
    </div>

    <div id="laudo-hcg-container">
        <div class="laudo-pdf">
            <div class="laudo-header">
                <div class="header-left">
                    <img src="https://via.placeholder.com/100x50?text=LOGO" alt="Logo Prefeitura" class="logo-left">
                    <p>Prefeitura Municipal de Novo Hamburgo</p>
                    <p>Estado do Rio Grande do Sul</p>
                    <p>Secretaria Municipal de Sa√∫de</p>
                </div>
                <div class="header-right">
                    <div class="sms-title" style="font-size: 32pt; font-weight: bold;">NOVO</div>
                    <p class="city-name" style="font-size: 16pt;">HAMBURGO | SA√öDE</p>
                </div>
            </div>
            <div style="border-bottom: 2px solid black; margin-bottom: 10px; padding-bottom: 5px;">
                <p class="laudo-title" style="margin-top: 10px; margin-bottom: 5px;">TESTE R√ÅPIDO PARA DETEC√á√ÉO DE HCG</p>
            </div>

            <div class="info-box">
                <p class="box-title" style="text-align: center;">DADOS DA PACIENTE</p>
                <div class="laudo-grid-2">
                    <p><span class="info-label">Nome do usu√°rio:</span> <span id="pdf-hcg-nome"></span></p>
                    <p><span class="info-label">Prontu√°rio:</span> <span id="pdf-hcg-prontuario"></span></p>
                    <p><span class="info-label">Data de Nascimento:</span> <span id="pdf-hcg-nascimento"></span></p>
                    <p><span class="info-label">Identidade:</span> <span id="pdf-hcg-identidade"></span></p>
                    <p><span class="info-label">Unidade de realiza√ß√£o do exame:</span> <span style="display: inline-block; width: auto;">Posto de Sa√∫de Central</span></p>
                    <p><span class="info-label">Sexo:</span> <span style="display: inline-block; width: auto;">FEMININO</span></p>
                    <p><span class="info-label">Data da coleta da amostra:</span> <span id="pdf-hcg-data-coleta"></span></p>
                </div>
            </div>

            <div class="info-box" style="margin-top: 15px;">
                <p class="box-title" style="text-align: center;">INFORMA√á√ïES DO TESTE</p>
                <div class="laudo-grid-2">
                    <p><span class="info-label">Amostras:</span> Urina</p>
                    <p><span class="info-label">Lote:</span> <span id="pdf-hcg-lote"></span></p>
                    <p><span class="info-label">Teste:</span> <span id="pdf-hcg-teste"></span></p>
                    <p><span class="info-label">Validade:</span> <span id="pdf-hcg-validade"></span></p>
                    <p><span class="info-label">M√©todo:</span> <span id="pdf-hcg-metodo"></span></p>
                </div>
            </div>

            <div class="result-box" style="margin-top: 15px;">
                <p class="box-title" style="text-align: center;">RESULTADO DO TESTE:</p>
                <p class="single-line-result"><span id="pdf-hcg-resultado"></span></p>
            </div>

            <div class="nota-box" style="margin-top: 15px;">
                <p><strong>Valor de refer√™ncia:</strong> NEGATIVO: &lt; 25mUI/mL - POSITIVO: &gt; 25mUI/mL.</p>
                <p>A produ√ß√£o do HCG se inicia nos primeiros dias ap√≥s a concep√ß√£o e √© bastante vari√°vel entre os indiv√≠duos. O valor negativo associado ao atraso menstrual de poucos dias n√£o exclui gesta√ß√£o. Nestes casos, o crit√©rio cl√≠nico, sugerimos: refazer o exame ap√≥s sete dias, uma vez que na presen√ßa de gravidez, os valores aumentam significativamente. Na gravidez, os maiores valores s√£o encontrados em torno de 8 a 10 semanas ap√≥s o √∫ltimo ciclo menstrual. Por volta da d√©cima segunda semana de gesta√ß√£o as concentra√ß√µes deste horm√¥nio diminuem.</p>
            </div>

            <div class="signature-section" style="margin-top: 20mm;">
                <div class="signature-box" style="text-align: left;">
                    <p class="signature-name"><span id="pdf-hcg-profissional"></span></p>
                    <p class="signature-line" style="width: 70%;"></p>
                    <p>Respons√°vel T√©cnico:</p>
                    <p>(carimbo e assinatura)</p>
                </div>
                <div class="signature-box" style="text-align: right;">
                    <p>Data: <span id="pdf-hcg-data-emissao"></span></p>
                </div>
            </div>

            <div class="laudo-footer">
                <hr>
                <p>Este laudo possui car√°ter meramente informativo e ilustrativo e jamais deve ser utilizado, sob hip√≥tese alguma, com finalidade de diagn√≥stico, ado√ß√£o de medicamentos ou de quaisquer outros procedimentos relacionados √† sa√∫de, sem a pr√©via orienta√ß√£o m√©dica e/ou orienta√ß√£o de um profissional de sa√∫de especializado.</p>
                <hr>
                <p>www.novohamburgo.rs.gov.br</p>
                <p>Centro Administrativo Leopoldo Petry | Rua Guia Lopes, 4201 - B. Canudos - 93548-013 | Novo Hamburgo - RS - Fone: 51 3097.9400</p>
                <p>Contribua com o Fundo Municipal de Sa√∫de de Novo Hamburgo. Doe Dengue, Doe Medula √ìssea. DOE SANGUE. DOE VIDA!</p>
            </div>
        </div>
    </div>

    <div id="loader" class="loader-overlay">
        <div class="loader"></div>
        <p>Carregando...</p>
    </div>

    <script>
        // --- CONSTANTES E ESTADO GLOBAL ---
        const SUPABASE_URL = 'https://tkuevwbztqytsxvuynzh.supabase.co';
        // A CHAVE ANONIMA DO SUPABASE FOI RESTAURADA PARA A ORIGINAL DO SEU C√ìDIGO INICIAL.
        // SE ESTIVER EXPIRADA, VOC√ä PRECISAR√Å ATUALIZ√Å-LA MANUALMENTE NO PAINEL DO SUPABASE.
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRrdWV2d2J6dHF5dHN4dnV5bnpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3NDc1MDYsImV4cCI6MjA2ODMyMzUwNn0.kAQtz0BWFf9yk1MmU6WbtCHLniwkPNUlMm2Dqi36YUU';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const ADMIN_PASSWORD = '159753';
        let dbTestes = [];
        let dbEstoque = [];
        let dbIndicadores = []; // Adicionado array para indicadores
        let typeChart, resultChart;

        // --- FUN√á√ïES DE UI E UTILIT√ÅRIOS ---
        function toggleLoader(show, message = "Processando...") {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.querySelector('p').textContent = message;
                loader.style.display = show ? 'flex' : 'none';
            }
        }

        // --- L√ìGICA DE DADOS COM SUPABASE ---
        async function carregarDadosIniciais() {
            toggleLoader(true, "Carregando dados...");
            console.log('Iniciando carregamento de dados do Supabase...');

            const { data: estoqueData, error: estoqueError } = await supabaseClient.from('estoque').select('*').order('id', { ascending: false });
            if (estoqueError) {
                console.error('Erro ao carregar estoque do Supabase:', estoqueError);
                alert(`Erro ao carregar estoque: ${estoqueError.message}. Verifique sua chave API e conex√£o.`);
                toggleLoader(false);
                return;
            }
            dbEstoque = estoqueData;
            console.log('Estoque carregado:', dbEstoque);

            const { data: testesData, error: testesError } = await supabaseClient.from('testes').select('*').order('id', { ascending: false });
            if (testesError) {
                console.error('Erro ao carregar testes do Supabase:', testesError);
                alert(`Erro ao carregar testes: ${testesError.message}. Verifique sua chave API e conex√£o.`);
                toggleLoader(false);
                return;
            }
            dbTestes = testesData;
            console.log('Testes carregados:', dbTestes);

            // Carregar dados de indicadores
            const { data: indicadoresData, error: indicadoresError } = await supabaseClient.from('indicadores').select('*').order('created_at', { ascending: false });
            if (indicadoresError) {
                console.error('Erro ao carregar indicadores do Supabase:', indicadoresError);
                alert(`Erro ao carregar indicadores: ${indicadoresError.message}.`);
                toggleLoader(false);
                return;
            }
            dbIndicadores = indicadoresData;
            console.log('Indicadores carregados:', dbIndicadores);
            
            showPage('dashboard');
            toggleLoader(false);
            console.log('Dados iniciais carregados e dashboard exibido.');
        }

        async function salvarTeste(tipo) {
            const profissional = document.getElementById('profissional-responsavel').value;
            if (!profissional) { alert('Por favor, informe o profissional respons√°vel.'); return; }
            const loteIdStr = document.getElementById(`${tipo.toLowerCase()}-lote`).value;
            if (!loteIdStr) { alert('Por favor, selecione um lote.'); return; }

            const loteId = parseInt(loteIdStr, 10);
            const estoqueItem = dbEstoque.find(item => item.id === loteId);

            if (!estoqueItem) { alert('Erro fatal: Lote n√£o encontrado. Por favor, recarregue a p√°gina.'); return; }
            if(estoqueItem.quantidade <= 0) { alert('Erro: Lote selecionado n√£o possui estoque!'); return; }

            let formValido = true;
            const payload = { tipo, profissional: profissional.toUpperCase(), lote_usado: estoqueItem.lote };

            if (tipo === 'DENGUE') {
                const dadosForm = {
                    nome: document.getElementById('dengue-nome').value.toUpperCase(),
                    cpf: document.getElementById('dengue-cpf').value,
                    nascimento: document.getElementById('dengue-nascimento').value,
                    sexo: document.getElementById('dengue-sexo').value.toUpperCase(),
                    inicioSintomas: document.getElementById('dengue-inicio-sintomas').value,
                    dataColeta: document.getElementById('dengue-data-coleta').value,
                    resultado: document.querySelector('input[name="dengue-resultado"]:checked')?.value
                };
                Object.assign(payload, {
                    nome: dadosForm.nome,
                    prontuario_cpf_id: dadosForm.cpf,
                    nascimento: dadosForm.nascimento,
                    data_coleta: dadosForm.dataColeta,
                    resultado: dadosForm.resultado,
                    detalhes_adicionais: dadosForm.sexo,
                    inicio_sintomas: dadosForm.inicioSintomas
                });
                if (!dadosForm.nome || !dadosForm.nascimento || !dadosForm.inicioSintomas || !dadosForm.dataColeta || !dadosForm.resultado) formValido = false;
            } else if (tipo === 'COVID') {
                const dadosForm = {
                    nome: document.getElementById('covid-nome').value.toUpperCase(),
                    cidade: document.getElementById('covid-cidade').value.toUpperCase(),
                    nascimento: document.getElementById('covid-nascimento').value,
                    sexo: document.getElementById('covid-sexo').value.toUpperCase(),
                    amostra: document.querySelector('input[name="covid-amostra"]:checked')?.value,
                    resultado: document.querySelector('input[name="covid-resultado"]:checked')?.value
                };
                Object.assign(payload, {
                    nome: dadosForm.nome,
                    prontuario_cpf_id: 'N/A',
                    nascimento: dadosForm.nascimento,
                    data_coleta: new Date().toISOString().slice(0, 10),
                    resultado: dadosForm.resultado,
                    detalhes_adicionais: `${dadosForm.amostra}|${dadosForm.sexo}|${dadosForm.cidade}`
                });
                if (!dadosForm.nome || !dadosForm.nascimento || !dadosForm.resultado) formValido = false;
            } else if (tipo === 'HCG') {
                const dadosForm = {
                    nome: document.getElementById('hcg-nome').value.toUpperCase(),
                    prontuario: document.getElementById('hcg-prontuario').value,
                    identidade: document.getElementById('hcg-identidade').value,
                    nascimento: document.getElementById('hcg-nascimento').value,
                    dataColeta: document.getElementById('hcg-data-coleta').value,
                    resultado: document.getElementById('hcg-resultado').value.toUpperCase()
                };
                Object.assign(payload, {
                    nome: dadosForm.nome,
                    prontuario_cpf_id: dadosForm.prontuario || dadosForm.identidade,
                    nascimento: dadosForm.nascimento,
                    data_coleta: dadosForm.dataColeta,
                    resultado: dadosForm.resultado,
                    detalhes_adicionais: 'N/A'
                });
                if (!dadosForm.nome || !dadosForm.nascimento || !dadosForm.dataColeta || !dadosForm.resultado) formValido = false;
            }
            if (!formValido) { alert('Por favor, preencha todos os campos obrigat√≥rios!'); return; }
            
            toggleLoader(true, "Salvando teste...");
            const { data: testeSalvo, error: testeError } = await supabaseClient.from('testes').insert([payload]).select().single();
            if (testeError) { alert(`Erro ao salvar o teste: ${testeError.message}`); toggleLoader(false); return; }

            const novaQuantidade = estoqueItem.quantidade - 1;
            const { error: estoqueError } = await supabaseClient.from('estoque').update({ quantidade: novaQuantidade }).eq('id', loteId);
            if (estoqueError) { alert(`Aten√ß√£o: Teste salvo, mas falha ao atualizar o estoque: ${estoqueError.message}`); }
            else { alert('Teste e estoque atualizados com sucesso!'); }
            
            await carregarDadosIniciais();
        }

        async function adicionarLote() {
            const tipo = document.getElementById('stock-tipo').value;
            const lote = document.getElementById('stock-lote').value.toUpperCase();
            const validade = document.getElementById('stock-validade').value;
            const quantidade = parseInt(document.getElementById('stock-quantidade').value);
            if (!tipo || !lote || !validade || isNaN(quantidade)) { alert('Preencha todos os campos para adicionar o lote.'); return; }
            
            toggleLoader(true, "Salvando lote...");
            const { data, error } = await supabaseClient.from('estoque').insert([{ tipo, lote, validade, quantidade }]).select().single();
            toggleLoader(false);

            if (error) { alert(`Erro ao salvar lote: ${error.message}`); return; }
            
            alert('Lote salvo com sucesso!');
            dbEstoque.unshift(data);
            document.getElementById('form-add-stock').reset(); 
            renderizarEstoque();
        }
        
        // --- Fun√ß√µes de Renderiza√ß√£o, UI, Navega√ß√£o e Autentica√ß√£o ---
        function renderizarEstoque() {
            const tbody = document.getElementById('stock-table-body'); tbody.innerHTML = ''; 
            if (!dbEstoque || dbEstoque.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum lote cadastrado no estoque.</td></tr>'; 
                return; 
            }
            dbEstoque.forEach(item => { 
                const row = document.createElement('tr'); 
                row.innerHTML = `<td>${item.tipo}</td><td>${item.lote}</td><td>${new Date(item.validade+'T00:00:00').toLocaleDateString('pt-BR')}</td><td>${item.quantidade}</td> 
                <td class="actions-cell"><button class="btn btn-edit btn-sm" onclick="editarLote(${item.id})">Editar</button><button class="btn btn-danger btn-sm" onclick="excluirLote(${item.id})">Excluir</button></td>`; 
                tbody.appendChild(row); 
            });
        }
        
        function renderizarRelatorios() {
            const tbody = document.getElementById('report-table-body'); tbody.innerHTML = ''; 
            if (!dbTestes || dbTestes.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Nenhum teste realizado ainda.</td></tr>'; 
                return; 
            }
            dbTestes.forEach(teste => { 
                const row = document.createElement('tr'); 
                row.innerHTML = `<td>${teste.nome}</td><td>${teste.prontuario_cpf_id || 'N/A'}</td><td>${teste.tipo}</td><td>${new Date(teste.data_coleta + 'T00:00:00').toLocaleDateString('pt-BR')}</td><td>${teste.resultado}</td><td>${teste.profissional}</td> 
                <td class="actions-cell"><button class="btn btn-secondary btn-sm" onclick="gerarPDF(${teste.id})">Gerar PDF</button><button class="btn btn-danger btn-sm" onclick="excluirTeste(${teste.id})">Excluir</button></td>`; 
                tbody.appendChild(row); 
            });
        }

        function renderDashboard() {
            if (typeof Chart === 'undefined') return; 
            const totalTestes = dbTestes.length; 
            const totalDengue = dbTestes.filter(t => t.tipo === 'DENGUE').length; 
            const totalCovid = dbTestes.filter(t => t.tipo === 'COVID').length; 
            const totalHcg = dbTestes.filter(t => t.tipo === 'HCG').length; 
            const totalPositivos = dbTestes.filter(t => String(t.resultado).includes('POSITIVO')).length; 
            
            document.getElementById('kpi-total-testes').textContent = totalTestes; 
            document.getElementById('kpi-total-dengue').textContent = totalDengue; 
            document.getElementById('kpi-total-covid').textContent = totalCovid; 
            document.getElementById('kpi-total-hcg').textContent = totalHcg; 
            document.getElementById('kpi-total-positivos').textContent = totalPositivos; 

            const typeCtx = document.getElementById('typeChart').getContext('2d'); 
            const resultCtx = document.getElementById('resultChart').getContext('2d'); 

            if(typeChart) typeChart.destroy(); 
            typeChart = new Chart(typeCtx, { 
                type: 'doughnut', 
                data: { 
                    labels: ['Dengue', 'COVID-19', 'HCG'], 
                    datasets: [{ 
                        data: [totalDengue, totalCovid, totalHcg], 
                        backgroundColor: ['#05668D', '#00A896', 'var(--hcg-color)'], 
                        borderColor: 'var(--card-bg)', 
                        borderWidth: 4 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    plugins: { 
                        legend: { position: 'top', labels: { color: 'var(--text-light)' } }, 
                        title: { display: true, text: 'Distribui√ß√£o por Tipo de Teste', color: 'var(--text-color)' } 
                    } 
                } 
            }); 
            
            const totalNegativos = dbTestes.filter(t => String(t.resultado).includes('NEGATIVO')).length; 
            const totalInconclusivos = dbTestes.filter(t => String(t.resultado).includes('INCONCLUSIVO')).length; 

            if(resultChart) resultChart.destroy(); 
            resultChart = new Chart(resultCtx, { 
                type: 'bar', 
                data: { 
                    labels: ['Positivo', 'Negativo', 'Inconclusivo'], 
                    datasets: [{ 
                        label: 'Resultados', 
                        data: [totalPositivos, totalNegativos, totalInconclusivos], 
                        backgroundColor: ['var(--danger-color)', 'var(--secondary-color)', 'var(--warning-color)'], 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { color: 'var(--border-color)' }, 
                            ticks: { color: 'var(--text-light)', stepSize: 1 } 
                        }, 
                        x: { 
                            grid: { color: 'transparent' }, 
                            ticks: { color: 'var(--text-light)' } 
                        } 
                    }, 
                    plugins: { 
                        legend: { display: false }, 
                        title: { display: true, text: 'Distribui√ß√£o de Resultados', color: 'var(--text-color)' } 
                    } 
                } 
            }); 
            
            const recentActivityBody = document.getElementById('recent-activity-body'); 
            recentActivityBody.innerHTML = ''; 
            const recentTests = dbTestes.slice(0, 5); 
            if (recentTests.length === 0) recentActivityBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum teste registrado ainda.</td></tr>'; 
            else recentTests.forEach(teste => { recentActivityBody.innerHTML += `<tr><td>${teste.nome}</td><td>${teste.tipo}</td><td>${teste.resultado}</td><td>${teste.profissional}</td></tr>`; });
        }
        
        function toggleTestForm() { 
            const tipo = document.getElementById('tipo-teste').value; 
            ['dengue', 'covid', 'hcg'].forEach(formType => { 
                document.getElementById(`form-${formType}`).style.display = tipo.toLowerCase() === formType ? 'block' : 'none'; 
            }); 
            popularDropdownLotes(tipo); 
        }
        
        function popularDropdownLotes(tipo) { 
            const dropdown = document.getElementById(`${tipo.toLowerCase()}-lote`); 
            if (!dropdown) return; 
            dropdown.innerHTML = '<option value="" disabled selected>Selecione um lote...</option>'; 
            const lotesDisponiveis = dbEstoque.filter(item => item.tipo === tipo && item.quantidade > 0); 
            if (lotesDisponiveis.length === 0) dropdown.innerHTML = '<option value="" disabled>Nenhum lote dispon√≠vel</option>'; 
            else lotesDisponiveis.forEach(lote => { 
                const option = document.createElement('option'); 
                option.value = lote.id; 
                option.textContent = `LOTE: ${lote.lote} | VAL: ${new Date(lote.validade+'T00:00:00').toLocaleDateString('pt-BR')} | QTD: ${lote.quantidade}`; 
                dropdown.appendChild(option); 
            }); 
        }

        function showPage(pageId) {
            if(pageId === 'estoque' && !checkAdminLogin()) { accessStockPage(); return; }
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const currentPage = document.getElementById(pageId);
            if(currentPage) currentPage.classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const activeLink = document.querySelector(`.nav-link[onclick*="'${pageId}'"]`);
            if(activeLink) activeLink.classList.add('active');
            
            if (pageId === 'dashboard') renderDashboard();
            else if (pageId === 'relatorios') renderizarRelatorios();
            else if (pageId === 'estoque') renderizarEstoque();
            else if (pageId === 'cadastro') toggleTestForm();
            else if (pageId === 'indicadores') renderizarIndicadores(); // Renderizar indicadores
        }

        function checkAdminLogin() { return sessionStorage.getItem('isAdmin') === 'true'; }
        function updateAdminUI() { document.getElementById('logout-link').style.display = checkAdminLogin() ? 'flex' : 'none'; }
        function accessStockPage() { if (checkAdminLogin()) { showPage('estoque'); return; } const password = prompt('Digite a senha de administrador:'); if (password === ADMIN_PASSWORD) { sessionStorage.setItem('isAdmin', 'true'); updateAdminUI(); showPage('estoque'); } else if (password !== null) { alert('Senha incorreta!'); } }
        function logout() { sessionStorage.removeItem('isAdmin'); updateAdminUI(); showPage('dashboard'); alert('Voc√™ saiu da sess√£o de administrador.'); }
        const themeSwitcher = document.getElementById('theme-switcher');
        function set_theme(theme_name) { localStorage.setItem('theme', theme_name); document.body.className = theme_name; themeSwitcher.textContent = theme_name === 'dark-theme' ? '‚òÄÔ∏è' : 'üåô'; }
        themeSwitcher.addEventListener('click', () => { if (localStorage.getItem('theme') === 'dark-theme') set_theme('light-theme'); else set_theme('dark-theme'); });
        
        document.addEventListener('DOMContentLoaded', async () => {
            updateAdminUI();
            set_theme(localStorage.getItem('theme') || 'light-theme');
            await carregarDadosIniciais();
        });

        async function excluirLote(id) {
            if (!confirm("Tem certeza que deseja excluir este lote? Esta a√ß√£o n√£o pode ser desfeita.")) return;
            toggleLoader(true, "Excluindo lote...");
            const { error } = await supabaseClient.from('estoque').delete().eq('id', id);
            if (error) { alert(`Erro ao excluir lote: ${error.message}`); }
            else { alert('Lote exclu√≠do com sucesso!'); await carregarDadosIniciais(); }
            toggleLoader(false);
        }

        async function excluirTeste(id) {
            if (!confirm("Tem certeza que deseja excluir este registro de teste?")) return;
            toggleLoader(true, "Excluindo teste...");
            const { error } = await supabaseClient.from('testes').delete().eq('id', id);
            if (error) { alert(`Erro ao excluir teste: ${error.message}`); }
            else { alert('Teste exclu√≠do com sucesso!'); await carregarDadosIniciais(); }
            toggleLoader(false);
        }

        async function editarLote(id) {
            const loteParaEditar = dbEstoque.find(l => l.id === id);
            if (!loteParaEditar) { alert('Lote n√£o encontrado!'); return; }
            const novoCodigo = prompt("Digite o novo c√≥digo do lote:", loteParaEditar.lote);
            const novaQtdStr = prompt("Digite a nova quantidade:", loteParaEditar.quantidade);
            
            const atualizacoes = {};
            if(novoCodigo && novoCodigo !== loteParaEditar.lote) atualizacoes.lote = novoCodigo.toUpperCase();
            if(novaQtdStr && !isNaN(parseInt(novaQtdStr)) && parseInt(novaQtdStr) !== loteParaEditar.quantidade) {
                atualizacoes.quantidade = parseInt(novaQtdStr);
            }

            if(Object.keys(atualizacoes).length === 0) { alert("Nenhuma altera√ß√£o feita."); return; }

            toggleLoader(true, "Atualizando lote...");
            const { error } = await supabaseClient.from('estoque').update(atualizacoes).eq('id', id);
            if (error) { alert(`Erro ao editar lote: ${error.message}`); }
            else { alert('Lote atualizado com sucesso!'); await carregarDadosIniciais(); }
            toggleLoader(false);
        }

        // --- FUN√á√ïES INDICADORES (NOVAS) ---
        async function salvarIndicador() {
            const gmus = document.getElementById('indicador-gmus').value;
            const pressao = document.getElementById('indicador-pressao').value;
            const hgt = parseFloat(document.getElementById('indicador-hgt').value);
            const peso = parseFloat(document.getElementById('indicador-peso').value);
            const estatura = parseFloat(document.getElementById('indicador-estatura').value);
            const profissional = document.getElementById('indicador-profissional').value;
            const obs = document.getElementById('indicador-obs').value;

            if (!gmus || !pressao || isNaN(hgt) || isNaN(peso) || isNaN(estatura) || !profissional) {
                alert('Por favor, preencha todos os campos obrigat√≥rios para o indicador.');
                return;
            }

            toggleLoader(true, "Salvando indicador...");
            const { data, error } = await supabaseClient.from('indicadores').insert([{ 
                gmus, pressao, hgt, peso, estatura, profissional, obs 
            }]).select().single();

            toggleLoader(false);

            if (error) { 
                alert(`Erro ao salvar indicador: ${error.message}`); 
                console.error('Erro ao salvar indicador:', error);
                return; 
            }
            
            alert('Indicador salvo com sucesso!');
            dbIndicadores.unshift(data); // Adiciona ao in√≠cio do array local
            document.getElementById('form-indicador').reset(); 
            renderizarIndicadores();
        }

        async function renderizarIndicadores() {
            const tbody = document.getElementById('indicators-table-body');
            tbody.innerHTML = ''; // Limpa a tabela
            if (!dbIndicadores || dbIndicadores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Nenhum indicador registrado ainda.</td></tr>';
                return;
            }

            dbIndicadores.forEach(indicator => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(indicator.created_at).toLocaleDateString('pt-BR')} ${new Date(indicator.created_at).toLocaleTimeString('pt-BR').slice(0, 5)}</td>
                    <td>${indicator.gmus || ''}</td>
                    <td>${indicator.pressao || ''}</td>
                    <td>${indicator.hgt || ''}</td>
                    <td>${indicator.peso || ''}</td>
                    <td>${indicator.estatura || ''}</td>
                    <td>${indicator.profissional || ''}</td>
                    <td>${indicator.obs || ''}</td>
                    <td class="actions-cell">
                        <button class="btn btn-edit btn-sm" onclick="editarIndicador(${indicator.id})">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="excluirIndicador(${indicator.id})">Excluir</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function editarIndicador(id) {
            const indicadorParaEditar = dbIndicadores.find(i => i.id === id);
            if (!indicadorParaEditar) { alert('Indicador n√£o encontrado!'); return; }

            // L√≥gica de prompt para edi√ß√£o (simplificada para demonstra√ß√£o)
            const novoGmus = prompt("Editar G'mus:", indicadorParaEditar.gmus);
            const novaPressao = prompt("Editar Press√£o:", indicadorParaEditar.pressao);
            const novoHgt = prompt("Editar HGT:", indicadorParaEditar.hgt);
            const novoPeso = prompt("Editar Peso:", indicadorParaEditar.peso);
            const novaEstatura = prompt("Editar Estatura:", indicadorParaEditar.estatura);
            const novoProfissional = prompt("Editar Profissional:", indicadorParaEditar.profissional);
            const novaObs = prompt("Editar Observa√ß√µes:", indicadorParaEditar.obs);

            const atualizacoes = {};
            if (novoGmus !== null) atualizacoes.gmus = novoGmus;
            if (novaPressao !== null) atualizacoes.pressao = novaPressao;
            if (novoHgt !== null && !isNaN(parseFloat(novoHgt))) atualizacoes.hgt = parseFloat(novoHgt);
            if (novoPeso !== null && !isNaN(parseFloat(novoPeso))) atualizacoes.peso = parseFloat(novoPeso);
            if (novaEstatura !== null && !isNaN(parseFloat(novaEstatura))) atualizacoes.estatura = parseFloat(novaEstatura);
            if (novoProfissional !== null) atualizacoes.profissional = novoProfissional;
            if (novaObs !== null) atualizacoes.obs = novaObs;

            if (Object.keys(atualizacoes).length === 0) { alert("Nenhuma altera√ß√£o feita."); return; }

            toggleLoader(true, "Atualizando indicador...");
            const { error } = await supabaseClient.from('indicadores').update(atualizacoes).eq('id', id);
            if (error) { alert(`Erro ao editar indicador: ${error.message}`); }
            else { alert('Indicador atualizado com sucesso!'); await carregarDadosIniciais(); }
            toggleLoader(false);
        }

        async function excluirIndicador(id) {
            if (!confirm("Tem certeza que deseja excluir este indicador? Esta a√ß√£o n√£o pode ser desfeita.")) return;
            toggleLoader(true, "Excluindo indicador...");
            const { error } = await supabaseClient.from('indicadores').delete().eq('id', id);
            if (error) { alert(`Erro ao excluir indicador: ${error.message}`); }
            else { alert('Indicador exclu√≠do com sucesso!'); await carregarDadosIniciais(); }
            toggleLoader(false);
        }

        function exportIndicators(format) {
            if (dbIndicadores.length === 0) {
                alert('Nenhum dado para exportar.');
                return;
            }

            const headers = ["Data", "G'mus", "Press√£o", "HGT", "Peso", "Estatura", "Profissional", "Obs"];
            const dataToExport = dbIndicadores.map(indicator => ([
                new Date(indicator.created_at).toLocaleDateString('pt-BR') + ' ' + new Date(indicator.created_at).toLocaleTimeString('pt-BR').slice(0, 5),
                indicator.gmus,
                indicator.pressao,
                indicator.hgt,
                indicator.peso,
                indicator.estatura,
                indicator.profissional,
                indicator.obs
            ]));

            if (format === 'csv') {
                let csvContent = headers.join(",") + "\n";
                dataToExport.forEach(row => {
                    csvContent += row.map(e => `"${String(e).replace(/"/g, '""')}"`).join(",") + "\n";
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "relatorio_indicadores.csv";
                link.click();
            } else if (format === 'pdf') {
                // Criar um elemento HTML tempor√°rio para o PDF
                const pdfContainer = document.createElement('div');
                pdfContainer.style.width = '210mm'; // Largura A4
                pdfContainer.style.padding = '10mm';
                pdfContainer.style.fontSize = '10pt';
                pdfContainer.style.fontFamily = 'Arial, sans-serif';

                let pdfHtml = `
                    <h2 style="text-align: center;">Relat√≥rio de Indicadores</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                        <thead>
                            <tr style="background-color: #f2f2f2;">
                                ${headers.map(h => `<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${dataToExport.map(row => `
                                <tr>
                                    ${row.map(cell => `<td style="border: 1px solid #ddd; padding: 8px;">${cell}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                pdfContainer.innerHTML = pdfHtml;

                // Esconder temporariamente o container para que html2pdf possa renderiz√°-lo sem interferir na UI vis√≠vel
                pdfContainer.style.position = 'fixed';
                pdfContainer.style.top = '-3000px';
                pdfContainer.style.left = '-3000px';
                document.body.appendChild(pdfContainer); // Adiciona ao DOM para html2pdf processar

                toggleLoader(true, "Gerando Relat√≥rio PDF...");
                html2pdf().set({
                    margin: 5, // Margens reduzidas para relat√≥rio
                    filename: 'relatorio_indicadores.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } // Orienta√ß√£o paisagem para mais colunas
                }).from(pdfContainer).save().then(() => {
                    document.body.removeChild(pdfContainer); // Remove o container tempor√°rio
                    toggleLoader(false);
                }).catch(error => {
                    console.error('Erro ao gerar PDF do relat√≥rio:', error);
                    alert('Erro ao gerar relat√≥rio PDF: ' + error.message);
                    document.body.removeChild(pdfContainer);
                    toggleLoader(false);
                });
            }
        }


        function gerarPDF(testeId) {
            console.log('--- In√≠cio da fun√ß√£o gerarPDF ---');
            console.log('ID do teste a ser gerado:', testeId);
            console.log('Conte√∫do atual de dbTestes:', dbTestes);

            const teste = dbTestes.find(t => t.id === testeId);
            
            if(!teste) {
                console.error('Erro: Objeto teste n√£o encontrado em dbTestes para o ID:', testeId);
                alert('Erro: Teste n√£o encontrado para gerar PDF. Verifique o console para mais detalhes.');
                return;
            }
            console.log('Objeto teste encontrado para PDF:', teste);

            let laudoContainerId;
            let laudoContentElement;

            // Formatar datas para exibi√ß√£o (DD/MM/AAAA)
            const formatDate = (dateString) => {
                if (!dateString) return '';
                let date = new Date(dateString); 
                if (isNaN(date.getTime()) && dateString.includes('-')) {
                    date = new Date(dateString + 'T00:00:00');
                }
                if (isNaN(date.getTime())) {
                    console.warn(`Data inv√°lida fornecida para formata√ß√£o: "${dateString}". Retornando string vazia.`);
                    return '';
                }
                return date.toLocaleDateString('pt-BR');
            };
            const currentFormattedDate = new Date().toLocaleDateString('pt-BR');

            const estoqueItem = dbEstoque.find(item => item.lote === teste.lote_usado && item.tipo === teste.tipo);
            const loteValidade = estoqueItem ? formatDate(estoqueItem.validade) : 'N/A';
            console.log('Lote Validade:', loteValidade);


            if (teste.tipo === 'DENGUE') {
                laudoContainerId = 'laudo-dengue-container';
                laudoContentElement = document.getElementById(laudoContainerId).firstElementChild;

                console.log('Preenchendo laudo DENGUE...');
                document.getElementById('pdf-dengue-nome').textContent = teste.nome || '';
                document.getElementById('pdf-dengue-cpf').textContent = teste.prontuario_cpf_id || 'N/A';
                document.getElementById('pdf-dengue-nascimento').textContent = formatDate(teste.nascimento) || '';
                document.getElementById('pdf-dengue-sexo').textContent = teste.detalhes_adicionais || 'N/A';
                document.getElementById('pdf-dengue-lote').textContent = teste.lote_usado || '';
                document.getElementById('pdf-dengue-validade').textContent = loteValidade;
                document.getElementById('pdf-dengue-data-coleta').textContent = formatDate(teste.data_coleta) || '';
                document.getElementById('pdf-dengue-inicio-sintomas').textContent = teste.inicio_sintomas ? formatDate(teste.inicio_sintomas) : 'N/A';
                document.getElementById('dengue-result-positivo').checked = (teste.resultado === 'POSITIVO');
                document.getElementById('dengue-result-negativo').checked = (teste.resultado === 'NEGATIVO');
                document.getElementById('dengue-result-inconclusivo').checked = (teste.resultado === 'INCONCLUSIVO');
                document.getElementById('pdf-dengue-profissional').textContent = teste.profissional || '';
                document.getElementById('pdf-dengue-data-emissao').textContent = currentFormattedDate;
                console.log('Laudo DENGUE preenchido.');


            } else if (teste.tipo === 'COVID') {
                laudoContainerId = 'laudo-covid-container';
                laudoContentElement = document.getElementById(laudoContainerId).firstElementChild;
                
                console.log('Preenchendo laudo COVID...');
                const detalhesCovid = (teste.detalhes_adicionais || 'N/A|N/A|N/A').split('|');
                const amostraCovid = detalhesCovid[0] || 'N/A';
                const sexoCovid = detalhesCovid[1] || 'N/A';
                const cidadeCovid = detalhesCovid[2] || 'NOVO HAMBURGO'; 

                // Preenchimento de texto
                if (document.getElementById('pdf-covid-nome')) document.getElementById('pdf-covid-nome').textContent = teste.nome || '';
                if (document.getElementById('pdf-covid-nascimento')) document.getElementById('pdf-covid-nascimento').textContent = formatDate(teste.nascimento) || '';
                if (document.getElementById('pdf-covid-sexo')) document.getElementById('pdf-covid-sexo').textContent = sexoCovid;
                if (document.getElementById('pdf-covid-cidade')) document.getElementById('pdf-covid-cidade').textContent = cidadeCovid;
                if (document.getElementById('pdf-covid-lote')) document.getElementById('pdf-covid-lote').textContent = teste.lote_usado || '';
                if (document.getElementById('pdf-covid-data-coleta')) document.getElementById('pdf-covid-data-coleta').textContent = formatDate(teste.data_coleta) || currentFormattedDate; 
                if (document.getElementById('pdf-covid-profissional')) document.getElementById('pdf-covid-profissional').textContent = teste.profissional || '';
                if (document.getElementById('pdf-covid-fabricante')) document.getElementById('pdf-covid-fabricante').textContent = teste.fabricante || '(N√£o especificado)';
                if (document.getElementById('pdf-covid-metodo')) document.getElementById('pdf-covid-metodo').textContent = teste.metodo || 'Imunocromatografia';
                if (document.getElementById('pdf-covid-data-emissao')) document.getElementById('pdf-covid-data-emissao').textContent = currentFormattedDate;

                // Preenchimento de checkboxes
                if (document.getElementById('covid-amostra-nasofaringeo')) document.getElementById('covid-amostra-nasofaringeo').checked = (amostraCovid === 'SWAB NASOFARINGEO');
                if (document.getElementById('covid-amostra-nasal')) document.getElementById('covid-amostra-nasal').checked = (amostraCovid === 'SWAB NASAL');
                
                if (document.getElementById('covid-result-positivo')) document.getElementById('covid-result-positivo').checked = (teste.resultado === 'POSITIVO');
                if (document.getElementById('covid-result-negativo')) document.getElementById('covid-result-negativo').checked = (teste.resultado === 'NEGATIVO');
                
                console.log('Laudo COVID preenchido.');


            } else if (teste.tipo === 'HCG') {
                laudoContainerId = 'laudo-hcg-container';
                laudoContentElement = document.getElementById(laudoContainerId).firstElementChild;
                
                console.log('Preenchendo laudo HCG...');
                // Preenchimento de texto
                if (document.getElementById('pdf-hcg-nome')) document.getElementById('pdf-hcg-nome').textContent = teste.nome || '';
                if (document.getElementById('pdf-hcg-prontuario')) document.getElementById('pdf-hcg-prontuario').textContent = teste.prontuario_cpf_id || 'N/A';
                if (document.getElementById('pdf-hcg-identidade')) document.getElementById('pdf-hcg-identidade').textContent = teste.prontuario_cpf_id || 'N/A';
                if (document.getElementById('pdf-hcg-nascimento')) document.getElementById('pdf-hcg-nascimento').textContent = formatDate(teste.nascimento) || '';
                if (document.getElementById('pdf-hcg-lote')) document.getElementById('pdf-hcg-lote').textContent = teste.lote_usado || '';
                const estoqueItemHCG = dbEstoque.find(item => item.lote === teste.lote_usado && item.tipo === 'HCG');
                if (document.getElementById('pdf-hcg-validade')) document.getElementById('pdf-hcg-validade').textContent = estoqueItemHCG ? formatDate(estoqueItemHCG.validade) : 'N/A';
                if (document.getElementById('pdf-hcg-data-coleta')) document.getElementById('pdf-hcg-data-coleta').textContent = formatDate(teste.data_coleta) || '';
                if (document.getElementById('pdf-hcg-resultado')) document.getElementById('pdf-hcg-resultado').textContent = teste.resultado || '';
                if (document.getElementById('pdf-hcg-profissional')) document.getElementById('pdf-hcg-profissional').textContent = teste.profissional || '';
                if (document.getElementById('pdf-hcg-data-emissao')) document.getElementById('pdf-hcg-data-emissao').textContent = currentFormattedDate;
                if (document.getElementById('pdf-hcg-teste')) document.getElementById('pdf-hcg-teste').textContent = teste.testeFabricante || '(N√£o especificado)';
                if (document.getElementById('pdf-hcg-metodo')) document.getElementById('pdf-hcg-metodo').textContent = teste.metodo || 'Imunocromatografia';
                
                console.log('Laudo HCG preenchido.');

            } else {
                console.warn('Tipo de teste desconhecido para gerar PDF:', teste.tipo);
                alert('Tipo de teste desconhecido para gerar PDF.');
                return;
            }

            console.log('Elemento do laudo a ser convertido:', laudoContentElement);
            const laudoElement = document.getElementById(laudoContainerId);
            if (!laudoElement || !laudoContentElement) {
                console.error('Erro: Container ou conte√∫do do laudo n√£o encontrado no HTML para o ID:', laudoContainerId);
                alert('Erro: Template do laudo n√£o encontrado no HTML. Verifique o console.');
                return;
            }

            laudoElement.style.display = 'block';
            laudoElement.style.left = '0';
            laudoElement.style.zIndex = '9998';

            toggleLoader(true, "Gerando PDF...");
            console.log('Iniciando convers√£o para PDF com html2pdf...');

            const opt = {
                margin: 0,
                filename: `Laudo_${teste.tipo}_${teste.nome.replace(/ /g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 1.0 },
                html2canvas: {
                    scale: 3,
                    useCORS: true,
                    logging: true
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(laudoContentElement).save().then(() => {
                console.log('PDF gerado com sucesso!');
                laudoElement.style.display = 'none';
                laudoElement.style.left = '-3000px';
                laudoElement.style.zIndex = '-1000';
                toggleLoader(false);
            }).catch(error => {
                console.error('Erro detalhado ao gerar PDF:', error);
                alert('Erro ao gerar PDF: ' + error.message + '. Verifique o console para mais detalhes.');
                laudoElement.style.display = 'none';
                laudoElement.style.left = '-3000px';
                laudoElement.style.zIndex = '-1000';
                toggleLoader(false);
            });
            console.log('--- Fim da fun√ß√£o gerarPDF ---');
        }
    </script>
</body>
</html>
